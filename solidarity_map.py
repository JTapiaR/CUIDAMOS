import streamlit as st
import folium
from folium.plugins import MarkerCluster
import pandas as pd
from streamlit_folium import st_folium
from geopy.geocoders import Nominatim  
from geopy.distance import geodesic
import streamlit as st
import folium
from folium.plugins import MarkerCluster
import pandas as pd
from streamlit_folium import st_folium
from geopy.geocoders import Nominatim
from geopy.exc import GeocoderTimedOut, GeocoderServiceError
from geopy.distance import geodesic

# Función para mostrar el mapa extendido de servicios
def show_extended_services_map():
    st.write("En este mapa puedes encontrar Empresas/Profesionistas y Gobiernos solidarios que ofrecen servicios a bajo costo o beneficios por los servicios de cuidado que provees")
    st.write("**información ficticia para propósitos de ilustración")
    # Datos de ejemplo para comercios solidarios y profesionales con servicios reducidos
    data = {'Nombre': ['Farmacia Solidaria',
  'Supermercado del Cuidado',
  'Psicólogo en Línea',
  'Dentista Amigable',
  'Taller Mecánico Solidario',
  'Clínica de Fisioterapia',
  'Tienda de Ropa Infantil',
  'Asesor Financiero',
  'Consultorio Médico Solidario',
  'Tienda de Ropa Infantil 54',
  'Dentista Amigable 10',
  'Asesor Financiero 7',
  'Clínica de Fisioterapia 38',
  'Consultorio Médico Solidario 66',
  'Taller Mecánico Solidario 69',
  'Psicólogo en Línea 19',
  'Clínica de Fisioterapia 71',
  'Psicólogo en Línea 66',
  'Asesor Financiero 6',
  'Taller Mecánico Solidario 50',
  'Supermercado del Cuidado 60',
  'Psicólogo en Línea 19',
  'Farmacia Solidaria 2',
  'Supermercado del Cuidado 39',
  'Taller Mecánico Solidario 3',
  'Tienda de Ropa Infantil 33',
  'Supermercado del Cuidado 85',
  'Asesor Financiero 6',
  'Dentista Amigable 15',
  'Psicólogo en Línea 8',
  'Consultorio Médico Solidario 92',
  'Psicólogo en Línea 92',
  'Consultorio Médico Solidario 25',
  'Psicólogo en Línea 45',
  'Psicólogo en Línea 73',
  'Asesor Financiero 50',
  'Psicólogo en Línea 22',
  'Psicólogo en Línea 8',
  'Clínica de Fisioterapia 86',
  'Supermercado del Cuidado 23',
  'Taller Mecánico Solidario 49',
  'Psicólogo en Línea 42',
  'Asesor Financiero 40',
  'Tienda de Ropa Infantil 33',
  'Dentista Amigable 55',
  'Clínica de Fisioterapia 37',
  'Taller Mecánico Solidario 40',
  'Consultorio Médico Solidario 49',
  'Tienda de Ropa Infantil 70',
  'Dentista Amigable 99',
  'Dentista Amigable 18',
  'Farmacia Solidaria 56',
  'Tienda de Ropa Infantil 94',
  'Taller Mecánico Solidario 26',
  'Taller Mecánico Solidario 24',
  'Psicólogo en Línea 67',
  'Psicólogo en Línea 63',
  'Supermercado del Cuidado 87',
  'Clínica de Fisioterapia 7',
  'Asesor Financiero 90',
  'Dentista Amigable 54',
  'Taller Mecánico Solidario 69',
  'Taller Mecánico Solidario 50',
  'Dentista Amigable 88',
  'Supermercado del Cuidado 35',
  'Psicólogo en Línea 75',
  'Farmacia Solidaria 42',
  'Supermercado del Cuidado 23',
  'Tienda de Ropa Infantil 13',
  'Tienda de Ropa Infantil 45',
  'Consultorio Médico Solidario 20',
  'Supermercado del Cuidado 84',
  'Tienda de Ropa Infantil 31',
  'Asesor Financiero 32',
  'Taller Mecánico Solidario 42',
  'Consultorio Médico Solidario 54',
  'Farmacia Solidaria 80',
  'Dentista Amigable 33',
  'Tienda de Ropa Infantil 43',
  'Taller Mecánico Solidario 41',
  'Taller Mecánico Solidario 37',
  'Farmacia Solidaria 52',
  'Consultorio Médico Solidario 100',
  'Farmacia Solidaria 94',
  'Taller Mecánico Solidario 96',
  'Consultorio Médico Solidario 35',
  'Consultorio Médico Solidario 98',
  'Taller Mecánico Solidario 66',
  'Asesor Financiero 68',
  'Consultorio Médico Solidario 4',
  'Taller Mecánico Solidario 63',
  'Asesor Financiero 40',
  'Clínica de Fisioterapia 28',
  'Asesor Financiero 36',
  'Tienda de Ropa Infantil 58',
  'Farmacia Solidaria 7',
  'Taller Mecánico Solidario 88',
  'Dentista Amigable 17',
  'Taller Mecánico Solidario 85',
  'Supermercado del Cuidado 81','Farmacia Iztapalapa', 'Supermercado Iztapalapa', 'Psicólogo en Línea', 
            'Dentista en Iztapalapa', 'Taller Mecánico Iztapalapa', 'Clínica de Fisioterapia Iztapalapa',
            'Farmacia Polanco', 'Supermercado Centro Histórico', 'Clínica en Polanco'],
 'Categoría': ['Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Comercio Solidario',
  'Comercio Solidario',
  'Comercio Solidario',
  'Comercio Solidario',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos',
  'Comercio Solidario',
  'Profesional con Servicios Reducidos','Comercio Solidario', 'Comercio Solidario', 'Profesional con Servicios Reducidos',
            'Profesional con Servicios Reducidos', 'Comercio Solidario', 'Profesional con Servicios Reducidos',
            'Comercio Solidario', 'Comercio Solidario', 'Profesional con Servicios Reducidos'],
 'Latitud': [19.4326,
  19.4256,
  19.4347,
  19.4396,
  19.4356,
  19.4333,
  19.4243,
  19.431,
  19.4295,
  19.4275,
  19.427,
  19.4356,
  19.4244,
  19.4318,
  19.4203,
  19.438,
  19.4269,
  19.4347,
  19.4279,
  19.4315,
  19.427,
  19.4261,
  19.427,
  19.4258,
  19.4249,
  19.4333,
  19.4281,
  19.4345,
  19.4376,
  19.426,
  19.4229,
  19.4248,
  19.4305,
  19.4249,
  19.4359,
  19.4329,
  19.4243,
  19.4309,
  19.4273,
  19.4304,
  19.4218,
  19.4297,
  19.422,
  19.4269,
  19.426,
  19.4339,
  19.4356,
  19.4221,
  19.4392,
  19.4363,
  19.4308,
  19.4306,
  19.4331,
  19.4254,
  19.4209,
  19.4373,
  19.4371,
  19.4222,
  19.4343,
  19.428,
  19.4315,
  19.4228,
  19.4365,
  19.4313,
  19.4256,
  19.4297,
  19.4293,
  19.437,
  19.4352,
  19.4286,
  19.4294,
  19.4376,
  19.4257,
  19.4276,
  19.4289,
  19.422,
  19.4324,
  19.4294,
  19.4211,
  19.4258,
  19.4209,
  19.4356,
  19.4211,
  19.4257,
  19.4267,
  19.4357,
  19.4309,
  19.4244,
  19.4298,
  19.4363,
  19.4355,
  19.4208,
  19.421,
  19.4319,
  19.44,
  19.4295,
  19.43,
  19.4247,
  19.4243,
  19.4399, 19.3574, 19.3600, 19.3589, 
            19.3604, 19.3561, 19.3598,
            19.4321, 19.4326, 19.4342],
 'Longitud': [-99.1332,
  -99.1342,
  -99.1323,
  -99.1353,
  -99.13,
  -99.1311,
  -99.1298,
  -99.1288,
  -99.1277,
  -99.1297,
  -99.1222,
  -99.1202,
  -99.1218,
  -99.1324,
  -99.1249,
  -99.1371,
  -99.129,
  -99.1259,
  -99.1313,
  -99.1255,
  -99.1365,
  -99.1345,
  -99.1202,
  -99.1316,
  -99.1373,
  -99.1201,
  -99.1221,
  -99.1355,
  -99.1387,
  -99.1216,
  -99.1307,
  -99.1213,
  -99.1241,
  -99.1379,
  -99.1276,
  -99.1393,
  -99.1373,
  -99.1331,
  -99.1392,
  -99.1296,
  -99.1344,
  -99.1336,
  -99.1212,
  -99.1218,
  -99.1272,
  -99.1243,
  -99.1364,
  -99.1379,
  -99.1382,
  -99.1349,
  -99.129,
  -99.1263,
  -99.1308,
  -99.1394,
  -99.1247,
  -99.1398,
  -99.1281,
  -99.1223,
  -99.1317,
  -99.1258,
  -99.1272,
  -99.1214,
  -99.1342,
  -99.1272,
  -99.1319,
  -99.14,
  -99.1215,
  -99.1333,
  -99.1214,
  -99.1364,
  -99.1358,
  -99.1372,
  -99.1257,
  -99.1334,
  -99.1315,
  -99.1352,
  -99.1332,
  -99.1347,
  -99.1311,
  -99.1369,
  -99.1327,
  -99.127,
  -99.1245,
  -99.1341,
  -99.1211,
  -99.1234,
  -99.136,
  -99.1315,
  -99.14,
  -99.1278,
  -99.1209,
  -99.1384,
  -99.1395,
  -99.1366,
  -99.1237,
  -99.1271,
  -99.1341,
  -99.1379,
  -99.1281,
  -99.1347, -99.0671, -99.0625, -99.0658,
            -99.0644, -99.0689, -99.0632,
            -99.2007, -99.1332, -99.2010]}

    # Convertir a un DataFrame
    df_servicios = pd.DataFrame(data)

    # Elegir entre un par de coordenadas de prueba
    st.write("Selecciona una ubicación de prueba para buscar servicios cercanos:")
    ubicacion = st.selectbox(
        "Selecciona la ubicación:",
        ["Ciudad de México", "Otra Ciudad (coordenadas de ejemplo)"]
    )

    # Definir coordenadas de prueba
    if ubicacion == "Centro Histórico de la Ciudad de México":
        latitud_input = 19.4326  # 
        longitud_input = -99.1332
    else:
        ubicacion == "Iztapalapa, Ciudad de México"
        latitud_input = 19.3574 # Coordenadas de ejemplo
        longitud_input = -99.0671

    st.write(f"Ubicación seleccionada: {ubicacion} (Lat: {latitud_input}, Lon: {longitud_input})")
    
    # Definir el radio de búsqueda
    radio_busqueda = st.slider("Radio de búsqueda (km)", min_value=1, max_value=50, value=5)

    # Crear el mapa centrado en la ubicación seleccionada
    mapa = folium.Map(location=[latitud_input, longitud_input], zoom_start=12)

    # Crear un cluster para agrupar los marcadores
    marker_cluster = MarkerCluster().add_to(mapa)

    # Filtrar los servicios que están dentro del radio de búsqueda
    servicios_cercanos = []
    for index, row in df_servicios.iterrows():
        distancia = geodesic((latitud_input, longitud_input), (row["Latitud"], row["Longitud"])).km
        if distancia <= radio_busqueda:
            servicios_cercanos.append(row)

            # Determinar color del marcador según la categoría
            if row["Categoría"] == "Comercio Solidario":
                color = "green"
            else:
                color = "blue"

            # Añadir marcador
            folium.Marker(
                location=[row["Latitud"], row["Longitud"]],
                popup=f"{row['Nombre']} ({row['Categoría']}) - {distancia:.2f} km",
                icon=folium.Icon(color=color)
            ).add_to(marker_cluster)

    # Mostrar el mapa en Streamlit
    st_folium(mapa, width=700, height=500)

    # Mostrar tabla de servicios cercanos
    if servicios_cercanos:
        st.write(f"Se encontraron {len(servicios_cercanos)} servicios cercanos:")
        st.dataframe(pd.DataFrame(servicios_cercanos))
    else:
        st.write("No se encontraron servicios cercanos dentro del radio de búsqueda.")

# Llamar a la función para mostrar el mapa extendido
show_extended_services_map()